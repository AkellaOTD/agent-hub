# Multi-Agent Chat Orchestrator

Инструмент для коллегиального планирования задач тремя AI-агентами (GPT, Claude, Gemini) под управлением человека-администратора.

Человек ставит задачу — агенты автоматически обсуждают, критикуют друг друга и формируют единый план.

## Как это работает

```
┌──────────────────────────────────────────────────────┐
│                    ADMIN (человек)                    │
│              ставит задачу, направляет                │
└──────────────┬───────────────────────┬────────────────┘
               │                       │
               ▼                       ▼
┌──────────────────────────────────────────────────────┐
│                  shared.jsonl / shared.md             │
│           общий чат — только выводы и предложения     │
└──┬──────────────────┬──────────────────┬─────────────┘
   │                  │                  │
   ▼                  ▼                  ▼
┌────────┐      ┌──────────┐      ┌──────────┐
│  GPT   │      │  CLAUDE  │      │  GEMINI  │
│context │◄────►│ context  │◄────►│ context  │
│.jsonl  │      │ .jsonl   │      │ .jsonl   │
└────────┘      └──────────┘      └──────────┘
 codex exec      claude -p        gemini -p
```

**Архитектура двойного контекста:**

- Каждый агент ведёт свой файл рассуждений (`context.jsonl`) — полный ход мысли, сомнения, альтернативы
- В общий чат (`shared.jsonl`) попадают только конкретные выводы и предложения
- Агенты могут читать контексты друг друга и указывать на ошибки в рассуждениях
- Человек видит выводы в реальном времени и может вмешаться после каждого раунда

**Цикл работы:**

1. Человек пишет задачу
2. **Раунд 1**: каждый агент предлагает свой вариант плана
3. **Раунд 2+**: агенты видят предложения друг друга, критикуют, уточняют, двигаются к консенсусу
4. После каждого раунда человек может добавить комментарий, посмотреть рассуждения агента или завершить сессию
5. По команде `/done` формируется итоговый `plan-final.md`

## Требования

- Python 3.10+
- CLI-инструменты агентов (установленные и авторизованные):

| Агент | CLI | Установка |
|-------|-----|-----------|
| GPT | [Codex CLI](https://github.com/openai/codex) | `npm install -g @openai/codex` |
| Claude | [Claude Code](https://docs.anthropic.com/en/docs/claude-code) | `npm install -g @anthropic-ai/claude-code` |
| Gemini | [Gemini CLI](https://github.com/google-gemini/gemini-cli) | `npm install -g @anthropic-ai/gemini-cli` или `npm install -g @google/gemini-cli` |

Каждый CLI должен быть авторизован (выполните `codex login`, `claude login`, `gemini login` перед первым запуском).

## Установка

### 1. Установите pip (если не установлен)

```bash
# Проверьте наличие pip
python3 -m pip --version

# Если pip не найден — установите:
curl -sS https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
python3 /tmp/get-pip.py --user --break-system-packages
```

### 2. Установите зависимости

```bash
cd /var/www/agent-hub
python3 -m pip install --user -r requirements.txt
```

Единственная зависимость — `pyyaml` для парсинга конфигов.

### 3. Создайте конфиг

```bash
cp config.example.yaml config.yaml
```

## Настройка

### Провайдеры (CLI)

| Провайдер | CLI команда | Описание |
|-----------|-------------|----------|
| `codex_cli` | `codex exec` | OpenAI Codex (GPT) |
| `claude_cli` | `claude -p` | Anthropic Claude Code |
| `gemini_cli` | `gemini -p` | Google Gemini CLI |

### Конфиг агентов

В `config.yaml`:

```yaml
agents:
  gpt:
    provider: codex_cli
    model: ""                    # по умолчанию из CLI, или "o4-mini", "o3" и т.д.
    system_prompt: |
      Твоя специализация и роль...
    max_tokens: 4096

  claude:
    provider: claude_cli
    model: ""                    # или "claude-sonnet-4-20250514"
    system_prompt: |
      Твоя специализация и роль...
    max_tokens: 4096

  gemini:
    provider: gemini_cli
    model: ""                    # или "gemini-2.0-flash"
    system_prompt: |
      Твоя специализация и роль...
    max_tokens: 4096
```

### Включение и отключение агентов

В `turn_order` перечислены только активные агенты. Чтобы отключить агента — уберите его из списка. Определение в секции `agents` можно оставить (он просто не будет вызываться):

```yaml
# Все три агента
turn_order: [gpt, claude, gemini]

# Без GPT — только Claude и Gemini
turn_order: [claude, gemini]

# Соло-режим — один агент
turn_order: [claude]
```

Порядок в списке определяет очерёдность ходов в каждом раунде.

### Параметры сессии

```yaml
turn_order: [gpt, claude, gemini]   # порядок ходов (только активные агенты)
max_rounds: 10                       # максимум раундов обсуждения
review_peers: true                   # агенты читают контексты друг друга
sessions_dir: ./sessions             # куда сохранять сессии
```

## Использование

### Новая сессия с задачей

```bash
python3 orchestrator.py --task "Спланировать систему авторизации для SaaS"
```
либо если задача большая

```bash
python3 orchestrator.py
```
и потом пишем задачу для агентов

### Новая сессия — задача интерактивно

```bash
python3 orchestrator.py
# Введите задачу, завершите Ctrl+D
```

### Продолжить существующую сессию

```bash
python3 orchestrator.py --resume sessions/2026-02-23-auth-planning/
```

### Указать другой конфиг

```bash
python3 orchestrator.py --config my-config.yaml --task "..."
```

### Анализ проекта в другой директории

```bash
python3 orchestrator.py --project-dir /var/www/anvalt --task "Проанализировать архитектуру проекта"
```

Или через конфиг:

```yaml
project_dir: /var/www/anvalt
```

В ходе сессии можно добавить дополнительные директории командой `/allow-dir /var/www/other`.

### Автоматический режим (без ввода человека)

```bash
python3 orchestrator.py --task "..." --rounds 3 --no-interactive
```

### Все параметры

| Параметр | Описание |
|----------|----------|
| `--config`, `-c` | Путь к конфигу (по умолчанию `config.yaml`) |
| `--task`, `-t` | Текст задачи |
| `--resume`, `-r` | Путь к сессии для продолжения |
| `--rounds` | Количество раундов (переопределяет конфиг) |
| `--no-interactive` | Без ввода человека между раундами |
| `--project-dir`, `-d` | Директория проекта для анализа (cwd для агентов) |

## Команды в интерактивном режиме

После каждого раунда (все агенты высказались) появляется приглашение:

| Команда | Действие |
|---------|----------|
| `Enter` | Продолжить следующий раунд |
| `/done` | Завершить сессию и сформировать итоговый план |
| `/status` | Показать состояние сессии (раунд, кол-во сообщений, артефакты) |
| `/read gpt` | Показать полные рассуждения GPT (аналогично `claude`, `gemini`) |
| `/artifacts` | Список созданных артефактов |
| `/artifact <name>` | Показать содержимое артефакта |
| `/summary` | Краткая сводка выводов по раундам |
| `/allow-dir <path>` | Разрешить агентам доступ к дополнительной директории |
| `/help` | Справка по командам |
| `/quit` | Приостановить сессию (можно продолжить через `--resume`) |
| любой текст | Добавить комментарий/направление в общий чат |

## Структура сессии

После запуска создаётся директория сессии:

```
sessions/2026-02-23-auth-planning/
├── config.yaml               # копия конфига
├── task.md                    # исходная задача
├── shared.jsonl               # общий чат (JSONL, для программ)
├── shared.md                  # общий чат (Markdown, для человека)
├── agents/
│   ├── gpt/
│   │   └── context.jsonl      # полные рассуждения GPT
│   ├── claude/
│   │   └── context.jsonl      # полные рассуждения Claude
│   └── gemini/
│       └── context.jsonl      # полные рассуждения Gemini
└── artifacts/
    ├── plan-gpt.md            # артефакт от GPT
    ├── plan-claude.md         # артефакт от Claude
    └── plan-final.md          # итоговый план (после /done)
```

**shared.md** — человекочитаемый файл со всеми выводами. Можно открыть в любом Markdown-просмотрщике.

**context.jsonl** — полные рассуждения агента. Используйте команду `/read <agent>` для просмотра или откройте файл напрямую.

**artifacts/** — планы, схемы и другие файлы, созданные агентами в блоках `[ARTIFACT:filename]`.

## Формат ответа агента

Каждый агент отвечает в формате двух блоков:

```
[THINKING]
Полные рассуждения, анализ, сомнения, альтернативы.
Записывается в личный контекст агента.
Другие агенты могут это прочитать и указать на ошибки.

[CONCLUSION]
Конкретные выводы и предложения.
Попадает в общий чат, видят все участники.
```

Агент может создавать артефакты внутри `[CONCLUSION]`:

```
[ARTIFACT:plan.md]
# План реализации
1. Шаг первый...
2. Шаг второй...
[/ARTIFACT]
```

## Примеры

### Планирование фичи

```bash
python3 orchestrator.py --task "Спланировать добавление двухфакторной аутентификации (2FA) в SaaS-платформу на Yii2. Нужно поддержать TOTP (Google Authenticator) и SMS. Учесть: миграции БД, API эндпоинты, UI компоненты, fallback/recovery коды."
```

### Декомпозиция задачи

```bash
python3 orchestrator.py --task "Декомпозировать задачу: перенести монолитное приложение на микросервисную архитектуру. Текущий стек: PHP/Yii2, MySQL, RabbitMQ. Нужен пошаговый план с приоритетами."
```

### Code review стратегия

```bash
python3 orchestrator.py --task "Разработать стратегию автоматического code review для команды из 5 разработчиков. Рассмотреть: линтеры, статический анализ, AI-review, CI/CD интеграцию, метрики качества."
```

### Использование 2 агентов

Отредактируйте `config.yaml`:

```yaml
turn_order: [claude, gemini]
```

Агенты, не указанные в `turn_order`, не участвуют.

## Troubleshooting

### CLI не найден

Убедитесь что CLI установлены и доступны:

```bash
which codex && codex --version
which claude && claude --version
which gemini && gemini --version
```

Если не найдены — установите через npm (см. раздел "Требования").

### CLI не авторизован

Выполните логин для каждого CLI:

```bash
codex login
claude login
gemini login
```

### Агент не отвечает / таймаут

CLI вызовы могут занимать 30–120 секунд. Таймаут по умолчанию — 600 секунд. Если агент стабильно не отвечает:
- Проверьте что CLI работает вручную: `claude -p "say OK"`
- Проверьте подписку/баланс у провайдера
- Проверьте интернет-соединение

### Неправильный формат ответа

Если агент не соблюдает формат `[THINKING]/[CONCLUSION]`, весь ответ попадёт в `[CONCLUSION]`. Это нормальное поведение — система продолжит работу.
